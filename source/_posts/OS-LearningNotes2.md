---
title: 从开机加电到执行main函数之前的过程
date: 2022-09-06 14:07:10
tags: 
  - 操作系统
  - Linux Kernel
  - BIOS
categories: 操作系统高级教程课堂笔记
description: 国科大杨力祥《操作系统高级教程》课堂笔记3 —— 开机加电后的过程
cover: https://s3.bmp.ovh/imgs/2022/08/30/57e6003529c041b7.webp
---

> 参考用书：《Linux内核设计的艺术》
> 
> 题外话：由于疫情，国科大现在实行线下上网课的形式。本节课就是大家全部到教室，然后老师共享屏幕来教学的，虽然互动减少了，但是还是干货满满。本周主要的笔记是记在电子版书上，下周可能会考虑整个思维导图，或许思路会更清晰。总之，开学前两周，先摸索一下学习方式。

# 引言
从开机加电到执行main函数之前，主要分为以下三个部分：
1. 启动BIOS，准备实模式下的中断向量表和中断服务程序
2. 从启动盘加载操作系统程序到内存：
    - bootsect程序（扇区 -> 主机内存）
    - setup程序（设置内核运行所需的机器系统数据）
    - head程序（保护模式，内存分页）
3. 为执行32位的main函数做过渡

# 启动BIOS
1. CPU的硬件都设置为加电进入实模式
2. BIOS程序被固化在ROM中，由**硬件方式**执行：加电瞬间，CS:IP指向BIOS程序的入口地址（0xFFFF0）
3. BIOS检测显卡、内存······，并且**在内存中建立中断向量表和中断服务程序**

> 补充知识：
> - ROM：只读存储器，断电之后仍能保存信息
> - 0x00400 = 4*(16^2)字节 = 4*256字节 = 1024字节 = 1KB

# 加载操作系统内核程序
## 加载第一部分内核代码——引导程序bootsect
**理解**： bootsect中sect是section的缩写，代表软盘。整个bootsect程序就是**将内核程序从软盘加载到主机内存**的过程。
**过程**：
1. CPU接收到一个int 0x19中断
2. 对应中断服务程序把软盘中第一扇区的程序（512B）加载到内存的指定位置（0x07C00）

{% asset_img p1.png p1 %}

> 冷知识：0x07C00来自Intel第一台个人电脑8088芯片，为了保持兼容，以后的CPU都保留此地址
## 加载第二部分内核代码——setup
BIOS将引导程序bootsect载入内存后，现在需要将第二批、第三批程序陆续加载到内存中。

**1.bootsect对内存的规划**
为了实现上述操作，bootsect首要工作就是先规划内存。如图，bootsect程序对后续操作涉及的内存位置进行了设置：
{% asset_img p2.png p2 %}

**2.复制bootsect**
接下来，bootsect将自身复制至内存0x90000（INITSEG）处：
{% asset_img p3.png p3 %}
**过程**：一遍执行，一边复制
**目的**：复制完后，就能根据自己的需要规划内存，程序可以执行更复杂的数据运算类指令了

**3.将setup程序加载到内存中**
通过BIOS提供的int 0x13中断向量指向的中断服务程序，将软盘第二扇区开始的4个扇区（即setup.s对应程序）加载到内存中（SETUPSEG）。
{% asset_img p4.png p4 %}
此时，操作系统已经从软盘中加载了5个扇区的代码。bootsect程序执行完后，setup程序就要开始工作了。

## 加载第三部分内核代码——system模块

**1.bootsect载入系统模块**
接下来，bootsect程序进行第三批程序的载入工作。首先，bootsect借助BIOS中断int 0x13，将240个扇区的system**系统模块加载进内存**。至此，整个操作系统的代码已全部加载至内存。bootsect还需要再确认一下根设备号，然后其工作就结束了！

> 补充：Linux0.11要求系统必须存在一个根文件系统，这里的文件系统☞配套文件系统格式的设备，如一张格式化好的软盘

**2.setup程序提取机器系统数据**
setup程序现在开始执行。首先，它利用BIOS中断服务程序从设备上提取内核所需要运行的机器系统数据（光标位置、显示页面等），并加载在内存中。
**注意**：BIOS提取的机器系统数据将覆盖bootsect程序所在部分区域，这提高了内存的利用率。
到此为止，内核已全部加载完成。接下来，系统将通过已加载到内存的代码，实现**从实模式到保护模式的转变**，使得Linux真正成为“现代”操作系统！
# 向32位模式转变 
本节，操作系统执行的操作包括打开32位的寻址空间、打开保护模式、建立保护模式下的中断响应机制等与保护模式相关的工作、建立内存分页机制，最后最好调用main函数的准备。